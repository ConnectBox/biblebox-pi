---

# Needed by Debian Official AMI
- name: Install aptitude
  apt:
    name: aptitude
    state: present
  when: ansible_lsb["id"] == "Debian"

# Debian-provided backports repo is used by Debian and Armbian
- name: Add Debian signing keys, to allow Debian backports repo
  apt_key:
    keyserver: hkp://keyserver.ubuntu.com:80
    state: present
    id: "{{ item }}"
  with_items:
    - 7638D0442B90D010
    - 8B48AD6246925553
  when: ansible_lsb["id"] != "Raspbian"

# No Debian armhf backports repo exists that runs on ARMv6 so we have our
#  own for the packages that we require
- name: Add ConnectBox signing key, to allow ConnectBox backports repo
  apt_key:
    url: https://eisbox.net/downloads/connectbox/repo/apt/conf/92F3A749.gpg.key
    state: present
  when: ansible_lsb["id"] == "Raspbian"

- name: Populate apt cache to avoid problems when loading jessie backport repo
  apt:
    update-cache: yes

- name: Enable Debian-provided Jessie backport repo (for Debian and Armbian)
  apt_repository:
    repo: deb http://httpredir.debian.org/debian jessie-backports main
    filename: debian-jessie-backports
    state: present
  when: ansible_lsb["id"] != "Raspbian"

# Connectbox-provided backports repo for Raspbian
- name: Enable Connectbox-provided Jessie backport repo for Raspbian
  apt_repository:
    repo: deb https://eisbox.net/downloads/connectbox/repo jessie-backports main
    filename: connectbox-jessie-backports
    state: present
  when: ansible_lsb["id"] == "Raspbian"

- name: Populate apt cache now that repos are loaded
  apt:
    update-cache: yes
#    cache_valid_time: 86400 # 1 day

# Needed by Debian Jessie
- name: Install openresolv
  apt:
    name: openresolv
    state: present
  when: ansible_lsb["id"] == "Debian"

# See if we need to create a wlan0 interface when we're running in a sim
#  environment i.e. running Debian
- name: Create a wlan0 interface
  command: /sbin/ip link add wlan0 type dummy
  when: "'wlan0' not in ansible_interfaces and ansible_lsb['id'] == 'Debian'"

# Non developer mode restricts ssh connections to ethernet
# This variable needs to be set before the mikegleasonjr.firewall role is run
- name: Set acceptable interfaces for inbound ssh
  set_fact:
    iptables_ssh_in_interface: "-i eth0"
  when: not developer_mode

